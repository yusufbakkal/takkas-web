<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İlan Detayı - TAKKAS</title>
    
    <!-- CSS Bağlantıları -->
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/property-detail-header.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/property-detail.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.25/bundle/libphonenumber-max.js"></script>
    <!-- Merkezi bildirim sistemi script'i -->
    <script src="assets/js/notification.js"></script>
    <style>
        /* Adres bölümü için stiller */
        .property-address {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .property-address h3 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            color: #333;
            border-bottom: 2px solid #4F46E5;
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .address-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .address-line {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
        }

        .address-line i {
            color: #4F46E5;
            font-size: 1.2rem;
        }

        .address-line span {
            font-weight: 500;
            color: #444;
        }

        @media (max-width: 768px) {
            .property-address {
                padding: 1rem;
            }
        }
    </style>
    <style>
        /* Bildirim stilleri */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.success {
            border-left: 4px solid #4CAF50;
        }
        
        .notification.error {
            border-left: 4px solid #f44336;
        }
        
        .notification.info {
            border-left: 4px solid #2196F3;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification i {
            font-size: 20px;
        }
        
        .notification.success i {
            color: #4CAF50;
        }
        
        .notification.error i {
            color: #f44336;
        }
        
        .notification.info i {
            color: #2196F3;
        }
        
        .notification.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Özel Header Bileşeni -->
    <div id="header-component"></div>

    <!-- Ana İçerik -->
    <main class="property-detail-container">
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
        </div>

        <div class="property-detail" id="propertyDetail">
            <!-- İlan detayları dinamik olarak buraya eklenecek -->
        </div>

        <div class="similar-properties">
            <h2>Benzer İlanlar</h2>
            <div class="property-grid" id="similarPropertiesGrid">
                <!-- Benzer emlak kartları dinamik olarak buraya eklenecek -->
            </div>
        </div>
    </main>

    <!-- Footer Bileşeni -->
    <div id="footer-component"></div>

    <!-- Lightbox -->
    <div id="imageLightbox" class="lightbox">
        <div class="lightbox-content">
            <span class="lightbox-close">&times;</span>
            <img class="lightbox-image" id="lightboxImage">
            <button class="lightbox-nav lightbox-prev">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-nav lightbox-next">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Message popup -->
    <div id="messagePopup" class="message-popup">
        <div class="message-popup-content">
            <div class="message-popup-header">
                <h3>Mesaj gönderin</h3>
                <button class="close-popup">&times;</button>
            </div>
            <div class="message-warning">
                <i class="fas fa-info-circle"></i>
                <span>Güvenliğiniz için kaparo göndermeyin ya da benzeri hiçbir ön ödeme yapmayın.</span>
            </div>
            <div class="message-user-info">
                <div class="message-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-user-details">
                    <div class="message-user-name">${ownerName}</div>
                </div>
            </div>
            <div class="message-quick-buttons">
                <button type="button" class="quick-message-btn">Hala satılık mı?</button>
                <button type="button" class="quick-message-btn">Son fiyat nedir?</button>
                <button type="button" class="quick-message-btn">Hasar durumu nedir?</button>
                <button type="button" class="quick-message-btn">Takas düşünür müsünüz?</button>
            </div>
            <form id="messageForm">
                <div class="form-group">
                    <textarea id="messageText" rows="4" placeholder="Mesaj yazın" required></textarea>
                    <div class="character-count">En az 10 karakter kullanmalısın · 8000 karakter kaldı</div>
                </div>
                <button type="submit" class="send-message-button">Gönder</button>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Bileşenleri yükle
        Promise.all([
            fetch('components/property-detail-header.html').then(response => response.text()),
            fetch('components/footer.html').then(response => response.text())
        ]).then(([header, footer]) => {
            document.getElementById('header-component').innerHTML = header;
            document.getElementById('footer-component').innerHTML = footer;
            
            // Sayfa yüklendikten sonra ilan detaylarını getir
            loadPropertyDetails();
        });

        // URL'den ilan ID'sini al
        function getPropertyIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || 3; // Varsayılan olarak 3 numaralı ilanı göster
        }

        // İlan detaylarını yükle
        async function loadPropertyDetails() {
            const propertyId = getPropertyIdFromUrl();
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');

            try {
                // API'den ilan detaylarını çek
                const propertyDetails = await fetchPropertyDetails(propertyId);
                
                // İlan detaylarını sayfaya ekle
                renderPropertyDetails(propertyDetails);
                
                // Benzer ilanları yükle
                loadSimilarProperties(propertyDetails.estate_type);
            } catch (error) {
                console.error('İlan detayları yüklenirken hata oluştu:', error);
                document.getElementById('propertyDetail').innerHTML = `
                    <div class="error-message">
                        <h2>Üzgünüz, ilan detayları yüklenemedi.</h2>
                        <p>Lütfen daha sonra tekrar deneyin.</p>
                    </div>
                `;
            } finally {
                spinner.classList.remove('active');
            }
        }

        // API'den ilan detaylarını çek
        async function fetchPropertyDetails(propertyId) {
            try {
                const apiUrl = `https://takkas-api.onrender.com/api/estates/${propertyId}`;
                console.log('API isteği gönderiliyor:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('API yanıt durumu:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`API isteği başarısız oldu: ${response.status} ${response.statusText}`);
                }
                
                let data = await response.json();
                console.log('API yanıtı:', data);
                
                // Adres bilgilerini al
                if (data.address_id) {
                    try {
                        const addressUrl = `https://takkas-api.onrender.com/api/addresses/${data.address_id}`;
                        console.log('Adres bilgisi için API isteği:', addressUrl);
                        
                        const addressResponse = await fetch(addressUrl);
                        
                        if (addressResponse.ok) {
                            const addressData = await addressResponse.json();
                            console.log('Adres API yanıtı:', addressData);
                            
                            // Adres verilerini emlak verilerine ekle
                            data = { 
                                ...data, 
                                province_name: addressData.city,
                                district_name: addressData.district,
                                neighborhood_name: addressData.neighborhood
                            };
                        } else {
                            console.error('Adres bilgileri alınamadı:', addressResponse.status);
                        }
                    } catch (addressError) {
                        console.error('Adres bilgileri alınırken hata oluştu:', addressError);
                    }
                }
                
                // Kategori bilgilerini al
                if (data.category_id) {
                    try {
                        const categoryUrl = `https://takkas-api.onrender.com/api/categories/${data.category_id}`;
                        console.log('Kategori bilgisi için API isteği:', categoryUrl);
                        
                        const categoryResponse = await fetch(categoryUrl);
                        
                        if (categoryResponse.ok) {
                            const categoryData = await categoryResponse.json();
                            console.log('Kategori API yanıtı:', categoryData);
                            
                            // Kategori adını emlak verilerine ekle
                            data.category_name = categoryData.name;
                        } else {
                            console.error('Kategori bilgileri alınamadı:', categoryResponse.status);
                        }
                    } catch (categoryError) {
                        console.error('Kategori bilgileri alınırken hata oluştu:', categoryError);
                    }
                }
                
                // İlan fotoğraflarını al
                try {
                    const photosUrl = `https://takkas-api.onrender.com/api/estate-photos/estate/${propertyId}`;
                    console.log('Fotoğraf bilgisi için API isteği:', photosUrl);
                    
                    const photosResponse = await fetch(photosUrl);
                    
                    if (photosResponse.ok) {
                        const photosData = await photosResponse.json();
                        console.log('Fotoğraf API yanıtı:', photosData);
                        
                        // Fotoğraf verilerini emlak verilerine ekle
                        data.photos = photosData;
                    } else {
                        console.error('Fotoğraf bilgileri alınamadı:', photosResponse.status);
                        data.photos = [];
                    }
                } catch (photosError) {
                    console.error('Fotoğraf bilgileri alınırken hata oluştu:', photosError);
                    data.photos = [];
                }
                
                return data;
            } catch (error) {
                console.error('İlan detayları çekilirken hata oluştu:', error);
                
                // Hata durumunda örnek veri döndür
                return {
                    id: 3,
                    estate_type: "villa",
                    title: "Baraka",
                    description: "Muhteşem deniz manzaralı, yeni yapılmış lüks daire. Fiyat güncellendi.",
                    price: "153700.00",
                    created_at: "2025-03-06T15:48:34.514Z",
                    square_meters_gross: "150.00",
                    square_meters_net: "135.00",
                    room_number: "8+1",
                    building_age: 0,
                    located_floor: 5,
                    total_floor: 12,
                    heating: "Doğalgaz",
                    bath_number: 2,
                    balcony: true,
                    lift: true,
                    parking: true,
                    furnished: false,
                    using_status: "Boş",
                    on_site: true,
                    site_name: "Deniz Panorama Evleri",
                    dues: "500.00",
                    deed_status: "Kat Mülkiyetli",
                    zoning_status: "Konut",
                    square_meters_price: "5000.00",
                    ada_no: null,
                    parsel_no: null,
                    pafta_no: null,
                    kaks: null,
                    gabari: null,
                    credit_status: true,
                    from_where: "Emlakçı",
                    user_id: 5,
                    address_id: 1,
                    category_id: 20,
                    // Örnek adres bilgileri
                    province_name: "İstanbul",
                    district_name: "Beşiktaş",
                    neighborhood_name: "Levent",
                    // Boş fotoğraf dizisi
                    photos: []
                };
            }
        }

        // İlan detaylarını sayfaya ekle
        function renderPropertyDetails(property) {
            console.log('--- renderPropertyDetails fonksiyonu çağrıldı ---', property);
            // Fotoğraf olup olmadığını kontrol et
            const hasPhotos = property.photos && property.photos.length > 0;
            
            // Fotoğrafları düzenle ve is_primary olanı öne çıkar
            let propertyImages = [];
            if (hasPhotos) {
                // primary olan görseli öne al
                const primaryPhotoIndex = property.photos.findIndex(photo => photo.is_primary === true);
                
                if (primaryPhotoIndex !== -1) {
                    // Primary olan görseli başa koy, diğerlerini sırala
                    const primaryPhoto = property.photos[primaryPhotoIndex];
                    const otherPhotos = property.photos.filter((_, index) => index !== primaryPhotoIndex);
                    propertyImages = [primaryPhoto, ...otherPhotos].map(photo => photo.url);
                } else {
                    // Primary yoksa tüm görselleri al
                    propertyImages = property.photos.map(photo => photo.url);
                }
            } else {
                // Fotoğraf yoksa placeholder göster
                propertyImages = ["https://via.placeholder.com/800x500/e0e0e0/333333?text=Fotoğraf+Bulunamadı"];
            }

            // İlanın arsa mı konut mu olduğunu kontrol et
            const isLand = property.estate_type === 'arsa';

            // Tarih formatını düzenle
            const createdDate = new Date(property.created_at);
            const formattedDate = createdDate.toLocaleDateString('tr-TR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Fiyatı formatla
            const formattedPrice = parseFloat(property.price).toLocaleString('tr-TR');
            
            // İlan sahibi bilgisini al
            const ownerName = property.user_name || property.from_where || 'Belirtilmemiş';

            // Telefon numarasını libphonenumber-js ile formatla
            function formatPhoneNumber(phone) {
                try {
                    if (!phone) return '';
                    let raw = phone.trim();
                    if (raw.startsWith('0')) raw = raw.slice(1);
                    if (!raw.startsWith('+90')) raw = '+90' + raw;
                    const parsed = libphonenumber.parsePhoneNumber(raw, 'TR');
                    return parsed.formatInternational(); // +90 555 123 45 67
                } catch {
                    return phone;
                }
            }

            // Kilit özellikler bölümünü ilan tipine göre oluştur
            const keyDetailsHtml = isLand ? `
                <div class="property-key-details">
                    <div class="key-detail-item">
                        <div class="key-detail-label">İlan Tipi</div>
                        <div class="key-detail-value">Arsa</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Alan</div>
                        <div class="key-detail-value">${property.square_meters_net} m²</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">İmar Durumu</div>
                        <div class="key-detail-value">${property.zoning_status}</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Ada No</div>
                        <div class="key-detail-value">${property.ada_no || 'Belirtilmemiş'}</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Parsel No</div>
                        <div class="key-detail-value">${property.parsel_no || 'Belirtilmemiş'}</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">KAKS/Emsal</div>
                        <div class="key-detail-value">${property.kaks || 'Belirtilmemiş'}</div>
                    </div>
                </div>
            ` : `
                <div class="property-key-details">
                    <div class="key-detail-item">
                        <div class="key-detail-label">İlan Tipi</div>
                        <div class="key-detail-value">${property.estate_type}</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Oda Sayısı</div>
                        <div class="key-detail-value">${property.room_number}</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Brüt m²</div>
                        <div class="key-detail-value">${property.square_meters_gross} m²</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Net m²</div>
                        <div class="key-detail-value">${property.square_meters_net} m²</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Bina Yaşı</div>
                        <div class="key-detail-value">${property.building_age} Yıl</div>
                    </div>
                    <div class="key-detail-item">
                        <div class="key-detail-label">Banyo Sayısı</div>
                        <div class="key-detail-value">${property.bath_number}</div>
                    </div>
                </div>
            `;

            // İlan tipi ikonu
            const estateTypeIcon = isLand ? 'fa-map-marker-alt' : 'fa-home';

            // İlan detay HTML'ini oluştur
            const propertyDetailHtml = `
                <div class="property-header">
                    <h1 class="property-title">${property.title}</h1>
                    <div class="property-meta">
                        <span class="property-type">${property.category_name || (isLand ? 'ARSA' : property.estate_type.toUpperCase())}</span>
                        <span class="property-date">İlan Tarihi: ${formattedDate}</span>
                    </div>
                </div>

                <div class="property-main-content">
                    <div class="property-gallery">
                        <div class="main-image">
                            <img src="${propertyImages[0]}" alt="${property.title}" id="mainImage">
                            ${propertyImages.length > 1 ? `
                            <button class="gallery-nav prev-btn" id="prevImage" aria-label="Önceki görsel">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="gallery-nav next-btn" id="nextImage" aria-label="Sonraki görsel">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            ` : ''}
                        </div>
                        ${propertyImages.length > 1 ? `
                        <div class="thumbnail-container">
                            ${propertyImages.map((img, index) => `
                                <div class="thumbnail ${index === 0 ? 'active' : ''}" data-index="${index}">
                                    <img src="${img}" alt="Görsel ${index + 1}">
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>

                    <div class="property-info-sidebar">
                        <div class="property-price-section">
                            <div class="property-price">${formattedPrice} TL</div>
                            <button class="favorite-button">
                                <i class="far fa-heart"></i>
                                <span>Favorilere Ekle</span>
                            </button>
                        </div>

                        ${keyDetailsHtml}

                        <div class="property-contact">
                            <h3>İletişim Bilgileri</h3>
                            <div class="contact-info">
                                <div class="contact-item">
                                    <i class="fas fa-user"></i>
                                    <span>${ownerName}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${formatPhoneNumber(property.user_phone) || '+90 (555) 123 45 67'}</span>
                                </div>
                            </div>
                            <button class="contact-button">İlan Sahibini Ara</button>
                            <a href="javascript:void(0);" class="message-link">
                                <i class="fas fa-envelope"></i> Mesaj Gönder
                            </a>
                        </div>
                    </div>
                </div>

                <div class="property-description">
                    <h3>İlan Açıklaması</h3>
                    <p>${property.description}</p>
                </div>

                <div class="property-address">
                    <h3>Adres Bilgileri</h3>
                    <div class="address-info">
                        <div class="address-line">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${property.province_name || 'İl'} / ${property.district_name || 'İlçe'} / ${property.neighborhood_name || 'Mahalle'}</span>
                        </div>
                    </div>
                </div>

                <div class="property-details-grid">
                    <h3>Tüm Özellikler</h3>
                    <div class="details-grid">
                        ${isLand ? generateLandDetailsHTML(property) : generateApartmentDetailsHTML(property)}
                        </div>
                        </div>
            `;

            document.getElementById('propertyDetail').innerHTML = propertyDetailHtml;

            // Message popup HTML'i
            const messagePopupHtml = `
                <div id="messagePopup" class="message-popup">
                    <div class="message-popup-content">
                        <div class="message-popup-header">
                            <h3>Mesaj gönderin</h3>
                            <button class="close-popup">&times;</button>
                        </div>
                        <div class="message-warning">
                            <i class="fas fa-info-circle"></i>
                            <span>Güvenliğiniz için kaparo göndermeyin ya da benzeri hiçbir ön ödeme yapmayın.</span>
                        </div>
                        <div class="message-user-info">
                            <div class="message-user-avatar">
                                <i class="fas fa-user"></i>
                        </div>
                            <div class="message-user-details">
                                <div class="message-user-name">${ownerName}</div>
                        </div>
                        </div>
                        <div class="message-quick-buttons">
                            <button type="button" class="quick-message-btn">Hala satılık mı?</button>
                            <button type="button" class="quick-message-btn">Son fiyat nedir?</button>
                            <button type="button" class="quick-message-btn">Hasar durumu nedir?</button>
                            <button type="button" class="quick-message-btn">Takas düşünür müsünüz?</button>
                        </div>
                        <form id="messageForm">
                            <div class="form-group">
                                <textarea id="messageText" rows="4" placeholder="Mesaj yazın" required></textarea>
                                <div class="character-count">En az 10 karakter kullanmalısın · 8000 karakter kaldı</div>
                        </div>
                            <button type="submit" class="send-message-button">Gönder</button>
                        </form>
                    </div>
                </div>
            `;

            // Message popup'ı body'e ekle
            // Önce mevcut popup'ı kaldır (varsa)
            const existingPopup = document.getElementById('messagePopup');
            if (existingPopup) {
                existingPopup.remove();
            }
            document.body.insertAdjacentHTML('beforeend', messagePopupHtml);

            // Message popup için değişkenler ve fonksiyonlar
            const messagePopup = document.getElementById('messagePopup');
            console.log('Emlak Detay - messagePopup elementi:', messagePopup);
            const messageLink = document.querySelector('.message-link');
            const closePopup = document.querySelector('.close-popup');
            const messageForm = document.getElementById('messageForm');
            console.log('Emlak Detay - messageForm elementi:', messageForm);
            const messageTextarea = document.getElementById('messageText');
            const characterCount = document.querySelector('.character-count');
            const quickButtons = document.querySelectorAll('.quick-message-btn');

            // Karakter sayacı fonksiyonu
            messageTextarea.addEventListener('input', function() {
                const remaining = 8000 - this.value.length;
                characterCount.textContent = `En az 10 karakter kullanmalısın · ${remaining} karakter kaldı`;
                
                // 10 karakterden az ise submit butonunu devre dışı bırak
                const submitButton = document.querySelector('.send-message-button');
                if (this.value.length < 10) {
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.5';
                } else {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                }
            });

            // Hızlı mesaj butonları
            quickButtons.forEach(button => {
                button.addEventListener('click', function() {
                    messageTextarea.value = this.textContent;
                    messageTextarea.dispatchEvent(new Event('input'));
                });
            });

            // Mesaj butonuna tıklandığında popup'ı göster
            messageLink.addEventListener('click', () => {
                messagePopup.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            });

            // Popup'ı kapatma işlemleri
            closePopup.addEventListener('click', () => {
                messagePopup.style.display = 'none';
                document.body.style.overflow = 'auto';
            });

            // Popup dışına tıklandığında kapat
            messagePopup.addEventListener('click', (e) => {
                if (e.target === messagePopup) {
                    messagePopup.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });

            // Form gönderildiğinde
            messageForm.addEventListener('submit', async (e) => {
                console.log('Emlak Detay - Mesaj Formu Submit Edildi');
                e.preventDefault();
                
                const authToken = localStorage.getItem('authToken');
                // const senderId = localStorage.getItem('userId'); // Backend JWT'den alacak

                if (!authToken) { // Sadece authToken kontrolü
                    showNotification('Mesaj gönderebilmek için giriş yapmanız gerekmektedir.', 'error');
                    return;
                }
                
                const content = messageTextarea.value;

                if (content.length < 10) {
                    showNotification('Mesajınız en az 10 karakter olmalıdır.', 'error');
                    return;
                }
                
                if (!property || property.user_id === undefined || property.user_id === null) {
                    showNotification('İlan sahibi bilgileri eksik. Mesaj gönderilemiyor.', 'error');
                    return; 
                }
                
                const sendMessageButton = messageForm.querySelector('.send-message-button');
                const originalButtonText = sendMessageButton.textContent;

                sendMessageButton.disabled = true;
                sendMessageButton.textContent = 'Gönderiliyor...';
                
                const messageData = {
                    receiverId: parseInt(property.user_id),
                    content: content
                };

                console.log('Gönderilecek Mesaj Verisi (Emlak):', JSON.stringify(messageData, null, 2));

                try {
                    const response = await fetch('https://takkas-api.onrender.com/api/messages/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(messageData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Mesaj gönderildi:', result);
                        showNotification('Mesajınız başarıyla gönderildi!', 'success');
                messageForm.reset();
                        messageTextarea.dispatchEvent(new Event('input')); 
                messagePopup.style.display = 'none';
                document.body.style.overflow = 'auto';
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Mesaj gönderilirken bir hata oluştu. Sunucu yanıtı okunamadı.' }));
                        console.error('Mesaj gönderme hatası:', errorData);
                        showNotification(errorData.message || 'Mesaj gönderilirken bir hata oluştu. Lütfen tekrar deneyin.', 'error');
                    }
                } catch (error) {
                    console.error('Mesaj gönderme sırasında bir ağ hatası oluştu:', error);
                    showNotification('Mesaj gönderilirken bir ağ hatası oluştu. Lütfen internet bağlantınızı kontrol edin.', 'error');
                } finally {
                    sendMessageButton.disabled = false;
                    sendMessageButton.textContent = originalButtonText;
                }
            });

            // Eğer fotoğraf yoksa galeri işlemlerini yapma
            if (!hasPhotos || propertyImages.length <= 1) {
                return;
            }
            
            // Görsel galerisi için değişkenler
            let currentImageIndex = 0;
            const images = propertyImages;
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail');
            const prevBtn = document.getElementById('prevImage');
            const nextBtn = document.getElementById('nextImage');
            
            // Ana görsel container'ı
            const mainImageContainer = document.querySelector('.main-image');
            
            // Dokunmatik kaydırma için değişkenler
            let touchStartX = 0;
            let touchEndX = 0;
            
            // Dokunmatik kaydırma olayları
            mainImageContainer.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            
            mainImageContainer.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const diffX = touchEndX - touchStartX;
                
                // Eğer kaydırma mesafesi küçükse, bu bir dokunma olarak kabul edilir
                if (Math.abs(diffX) < 10) {
                    lightboxImage.src = images[currentImageIndex];
                    lightbox.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else {
                    handleSwipe();
                }
            }, false);
            
            // Kaydırma işlemini yönet
            function handleSwipe() {
                const swipeThreshold = 50; // En az 50px kaydırma gerekli
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Sola kaydırma
                    changeImage(currentImageIndex + 1);
                }
                
                if (touchEndX > touchStartX + swipeThreshold) {
                    // Sağa kaydırma
                    changeImage(currentImageIndex - 1);
                }
            }
            
            // Görsel değiştirme fonksiyonu
            function changeImage(index) {
                if (index < 0) index = images.length - 1;
                if (index >= images.length) index = 0;
                
                currentImageIndex = index;
                mainImage.src = images[index];
                
                // Aktif thumbnail'i güncelle
                thumbnails.forEach(thumb => {
                    thumb.classList.remove('active');
                });
                thumbnails[index].classList.add('active');
            }
            
            // Önceki görsel butonu
            prevBtn.addEventListener('click', () => {
                changeImage(currentImageIndex - 1);
            });
            
            // Sonraki görsel butonu
            nextBtn.addEventListener('click', () => {
                changeImage(currentImageIndex + 1);
            });
            
            // Thumbnail tıklama olayları
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    const index = parseInt(thumb.getAttribute('data-index'));
                    changeImage(index);
                });
            });
            
            // Lightbox fonksiyonları
            const lightbox = document.getElementById('imageLightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            const lightboxClose = document.querySelector('.lightbox-close');
            const lightboxPrev = document.querySelector('.lightbox-prev');
            const lightboxNext = document.querySelector('.lightbox-next');
            const lightboxContent = document.querySelector('.lightbox-content');
            
            // Ana görsele tıklandığında lightbox'ı aç
            mainImage.addEventListener('click', openLightbox);
            
            // Thumbnail'lere tıklandığında da lightbox'ı aç
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    changeImage(index);
                    openLightbox();
                });
            });
            
            function openLightbox() {
                lightboxImage.src = images[currentImageIndex];
                lightbox.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            // Lightbox'ı kapat
            lightboxClose.addEventListener('click', closeLightbox);
            
            // Lightbox dışına tıklandığında kapat
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            function closeLightbox() {
                lightbox.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            // Lightbox içinde önceki görsel
            lightboxPrev.addEventListener('click', function() {
                changeImage(currentImageIndex - 1);
                lightboxImage.src = images[currentImageIndex];
            });
            
            // Lightbox içinde sonraki görsel
            lightboxNext.addEventListener('click', function() {
                changeImage(currentImageIndex + 1);
                lightboxImage.src = images[currentImageIndex];
            });
            
            // Klavye ile gezinme
            document.addEventListener('keydown', function(e) {
                if (lightbox.style.display === 'flex') {
                    if (e.key === 'ArrowLeft') {
                        changeImage(currentImageIndex - 1);
                        lightboxImage.src = images[currentImageIndex];
                    } else if (e.key === 'ArrowRight') {
                        changeImage(currentImageIndex + 1);
                        lightboxImage.src = images[currentImageIndex];
                    } else if (e.key === 'Escape') {
                        closeLightbox();
                    }
                }
            });
            
            // Lightbox içinde dokunmatik kaydırma
            let lightboxTouchStartX = 0;
            let lightboxTouchEndX = 0;
            
            lightboxImage.addEventListener('touchstart', function(e) {
                lightboxTouchStartX = e.changedTouches[0].screenX;
            });
            
            lightboxImage.addEventListener('touchend', function(e) {
                lightboxTouchEndX = e.changedTouches[0].screenX;
                handleLightboxSwipe();
            });
            
            function handleLightboxSwipe() {
                const swipeThreshold = 50;
                
                if (lightboxTouchEndX < lightboxTouchStartX - swipeThreshold) {
                    // Sola kaydırma
                    changeImage(currentImageIndex + 1);
                    lightboxImage.src = images[currentImageIndex];
                }
                
                if (lightboxTouchEndX > lightboxTouchStartX + swipeThreshold) {
                    // Sağa kaydırma
                    changeImage(currentImageIndex - 1);
                    lightboxImage.src = images[currentImageIndex];
                }
            }
            
            // Favoriye ekleme fonksiyonu
            document.querySelector('.favorite-button').addEventListener('click', function() {
                const icon = this.querySelector('i');
                icon.classList.toggle('far');
                icon.classList.toggle('fas');
                
                if (icon.classList.contains('fas')) {
                    this.querySelector('span').textContent = 'Favorilerden Çıkar';
                } else {
                    this.querySelector('span').textContent = 'Favorilere Ekle';
                }
            });
        }

        // Arsa detayları HTML'ini oluştur
        function generateLandDetailsHTML(property) {
            return `
                <div class="detail-item">
                    <div class="detail-label">İlan Tipi</div>
                    <div class="detail-value">Arsa</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Net m²</div>
                    <div class="detail-value">${property.square_meters_net} m²</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">m² Birim Fiyatı</div>
                    <div class="detail-value">${property.square_meters_price} TL</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">İmar Durumu</div>
                    <div class="detail-value">${property.zoning_status}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tapu Durumu</div>
                    <div class="detail-value">${property.deed_status}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Ada No</div>
                    <div class="detail-value">${property.ada_no || 'Belirtilmemiş'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Parsel No</div>
                    <div class="detail-value">${property.parsel_no || 'Belirtilmemiş'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Pafta No</div>
                    <div class="detail-value">${property.pafta_no || 'Belirtilmemiş'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">KAKS (Emsal)</div>
                    <div class="detail-value">${property.kaks || 'Belirtilmemiş'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Gabari</div>
                    <div class="detail-value">${property.gabari || 'Belirtilmemiş'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Krediye Uygunluk</div>
                    <div class="detail-value">${property.credit_status ? 'Uygun' : 'Uygun Değil'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kimden</div>
                    <div class="detail-value">${property.from_where || 'Belirtilmemiş'}</div>
                </div>
            `;
        }

        // Konut detayları HTML'ini oluştur
        function generateApartmentDetailsHTML(property) {
            return `
                <div class="detail-item">
                    <div class="detail-label">İlan Tipi</div>
                    <div class="detail-value">${property.estate_type}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Oda Sayısı</div>
                    <div class="detail-value">${property.room_number}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Brüt m²</div>
                    <div class="detail-value">${property.square_meters_gross} m²</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Net m²</div>
                    <div class="detail-value">${property.square_meters_net} m²</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Bina Yaşı</div>
                    <div class="detail-value">${property.building_age} Yıl</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Bulunduğu Kat</div>
                    <div class="detail-value">${property.located_floor}. Kat</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kat Sayısı</div>
                    <div class="detail-value">${property.total_floor}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Isıtma</div>
                    <div class="detail-value">${property.heating}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Banyo Sayısı</div>
                    <div class="detail-value">${property.bath_number}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Balkon</div>
                    <div class="detail-value">${property.balcony ? 'Var' : 'Yok'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Asansör</div>
                    <div class="detail-value">${property.lift ? 'Var' : 'Yok'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Otopark</div>
                    <div class="detail-value">${property.parking ? 'Var' : 'Yok'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Eşyalı</div>
                    <div class="detail-value">${property.furnished ? 'Evet' : 'Hayır'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kullanım Durumu</div>
                    <div class="detail-value">${property.using_status}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Site İçerisinde</div>
                    <div class="detail-value">${property.on_site ? 'Evet' : 'Hayır'}</div>
                </div>
                ${property.on_site ? `
                <div class="detail-item">
                    <div class="detail-label">Site Adı</div>
                    <div class="detail-value">${property.site_name}</div>
                </div>
                ` : ''}
                <div class="detail-item">
                    <div class="detail-label">Aidat</div>
                    <div class="detail-value">${property.dues} TL</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tapu Durumu</div>
                    <div class="detail-value">${property.deed_status}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">İmar Durumu</div>
                    <div class="detail-value">${property.zoning_status}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">m² Birim Fiyatı</div>
                    <div class="detail-value">${property.square_meters_price} TL</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Krediye Uygunluk</div>
                    <div class="detail-value">${property.credit_status ? 'Uygun' : 'Uygun Değil'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kimden</div>
                    <div class="detail-value">${property.from_where}</div>
                </div>
            `;
        }

        // Benzer ilanları yükle
        async function loadSimilarProperties(propertyType) {
            try {
                // API'den benzer ilanları çek
                const apiUrl = `https://takkas-api.onrender.com/api/estates?estate_type=${propertyType}`;
                console.log('Benzer ilanlar için API isteği gönderiliyor:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`API isteği başarısız oldu: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Benzer ilanlar API yanıtı:', data);
                
                // Benzer ilanları işle
                const estateData = Array.isArray(data) ? data : (data.results || data.data || []);
                
                // En fazla 4 benzer ilan göster
                const similarProperties = estateData.slice(0, 4);
                
                // Benzer ilanların fotoğraflarını çek
                const propertiesWithPhotos = await Promise.all(
                    similarProperties.map(async (property) => {
                        try {
                            const photosUrl = `https://takkas-api.onrender.com/api/estate-photos/estate/${property.id}`;
                            const photosResponse = await fetch(photosUrl);
                            
                            if (photosResponse.ok) {
                                const photosData = await photosResponse.json();
                                if (photosData && photosData.length > 0) {
                                    // Öncelikle primary olan fotoğrafı bul
                                    const primaryPhoto = photosData.find(photo => photo.is_primary === true);
                                    if (primaryPhoto) {
                                        property.photo_url = primaryPhoto.url;
                                    } else {
                                        property.photo_url = photosData[0].url;
                                    }
                                }
                            }
                            return property;
                        } catch (error) {
                            console.error(`${property.id} ID'li ilanın fotoğrafları çekilirken hata oluştu:`, error);
                            return property;
                        }
                    })
                );
                
                // Benzer ilanları sayfaya ekle
                renderSimilarProperties(propertiesWithPhotos);
            } catch (error) {
                console.error('Benzer ilanlar yüklenirken hata oluştu:', error);
                
                // Hata durumunda örnek veriler göster
                const dummyProperties = Array(4).fill().map((_, index) => ({
                    id: index + 10,
                    title: ['Lüks Villa', 'Modern Daire', 'Deniz Manzaralı', 'Bahçeli Ev'][index],
                    estate_type: 'villa',
                    price: 1000000 + (index * 500000),
                    room_number: `${2 + (index % 3)} + 1`,
                    square_meters_gross: 150 + (index * 25)
                }));
                
                renderSimilarProperties(dummyProperties);
            }
        }

        // Benzer ilanları sayfaya ekle
        function renderSimilarProperties(properties) {
            const similarPropertiesGrid = document.getElementById('similarPropertiesGrid');
            
            // Benzer ilanlar HTML'ini oluştur
            const similarPropertiesHtml = properties.map((property) => {
                // Fotoğraf yoksa placeholder göster
                const image = property.photo_url || "https://via.placeholder.com/400x250/e0e0e0/333333?text=Fotoğraf+Bulunamadı";
                const price = typeof property.price === 'number' ? property.price.toLocaleString() : property.price;
                
                return `
                    <article class="property-card">
                        <a href="property-detail.html?id=${property.id}" class="property-link">
                            <div class="property-content">
                                <header class="property-header">
                                    <div class="property-title-row">
                                        <h2 class="property-name">${property.title}</h2>
                                        <button class="property-favorite" aria-label="Favorilere ekle">
                                            <i class="far fa-heart"></i>
                                        </button>
                                    </div>
                                    <p class="property-type">${property.estate_type}</p>
                                </header>
                                <img src="${image}" alt="${property.title}" class="property-image">
                                <footer class="property-details">
                                    <div class="property-specs">
                                        <div class="spec-item">
                                            <i class="fas fa-bed spec-icon"></i>
                                            <span>${property.room_number}</span>
                                        </div>
                                    </div>
                                    <p class="property-price">
                                        <span class="price-amount">${price} TL</span>
                                    </p>
                                </footer>
                            </div>
                        </a>
                    </article>
                `;
            }).join('');
            
            similarPropertiesGrid.innerHTML = similarPropertiesHtml;
            
            // Favoriye ekleme fonksiyonu
            document.querySelectorAll('.property-favorite').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault(); // Link tıklamasını engelle
                    
                    this.classList.toggle('active');
                    const icon = this.querySelector('i');
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                });
            });
        }
    </script>
</body>
</html> 