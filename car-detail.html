<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Araç İlan Detayı - TAKKAS</title>
    
    <!-- CSS Bağlantıları -->
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/property-detail-header.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/car-detail.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Özel Header Bileşeni -->
    <div id="header-component"></div>

    <!-- Ana İçerik -->
    <main class="property-detail-container">
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
        </div>

        <div class="property-detail" id="carDetail">
            <!-- İlan detayları dinamik olarak buraya eklenecek -->
        </div>

        <!-- Benzer Araçlar Bölümü -->
        <section class="similar-cars-section" id="similarCarsContainer">
            <h2 class="similar-cars-title">Benzer Araçlar</h2>
            <div class="car-grid">
                <!-- Benzer araçlar dinamik olarak buraya eklenecek -->
            </div>
        </section>
    </main>

    <!-- Footer Bileşeni -->
    <div class="full-width-footer-wrapper">
        <div id="footer-component"></div>
    </div>

    <!-- Lightbox -->
    <div id="imageLightbox" class="lightbox">
        <div class="lightbox-content">
            <span class="lightbox-close">&times;</span>
            <img class="lightbox-image" id="lightboxImage">
            <button class="lightbox-nav lightbox-prev">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-nav lightbox-next">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Bileşenleri yükle
        Promise.all([
            fetch('components/property-detail-header.html').then(response => response.text()),
            fetch('components/footer.html').then(response => response.text())
        ]).then(([header, footer]) => {
            document.getElementById('header-component').innerHTML = header;
            document.getElementById('footer-component').innerHTML = footer;
            
            // Sayfa yüklendikten sonra ilan detaylarını getir
            loadCarDetails();
        });

        // URL'den ilan ID'sini al
        function getCarIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id'); // Varsayılan ID'yi kaldırdık
        }

        // İlan detaylarını yükle
        async function loadCarDetails() {
            const carId = getCarIdFromUrl();
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');

            // ID yoksa hata mesajı göster
            if (!carId) {
                spinner.classList.remove('active');
                document.getElementById('carDetail').innerHTML = `
                    <div class="error-message">
                        <h2>Üzgünüz, ilan bulunamadı.</h2>
                        <p>Geçersiz ilan ID'si. <a href="cars.html">Tüm ilanları görüntülemek için tıklayın.</a></p>
                    </div>
                `;
                return;
            }

            try {
                // API'den ilan detaylarını çek
                const carDetails = await fetchCarDetails(carId);
                
                // İlan detaylarını sayfaya ekle
                renderCarDetails(carDetails);
                
                // Benzer ilanları yükle
                loadSimilarCars(carId);
            } catch (error) {
                console.error('İlan detayları yüklenirken hata oluştu:', error);
                document.getElementById('carDetail').innerHTML = `
                    <div class="error-message">
                        <h2>Üzgünüz, ilan detayları yüklenemedi.</h2>
                        <p>Lütfen daha sonra tekrar deneyin veya <a href="cars.html">tüm ilanları görüntülemek için tıklayın.</a></p>
                    </div>
                `;
            } finally {
                spinner.classList.remove('active');
            }
        }

        // API'den ilan detaylarını çek
        async function fetchCarDetails(carId) {
            try {
                const apiUrl = `https://takkas-api.onrender.com/api/vehicle-listings/${carId}`;
                console.log('API isteği gönderiliyor:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('API yanıt durumu:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`API isteği başarısız oldu: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API yanıtı:', data);
                
                // API boş veri döndürürse veya data null/undefined ise hata fırlat
                if (!data || Object.keys(data).length === 0) {
                    throw new Error('İlan bulunamadı veya API boş veri döndürdü.');
                }
                
                return data;
            } catch (error) {
                console.error('İlan detayları çekilirken hata oluştu:', error);
                
                // Hata durumunda örnek veri döndür, ancak URL'den gelen ID'yi kullan
                const dummyCarId = parseInt(carId);
                
                // Örnek araç verileri - API'den gelen gerçek verilere göre güncellendi
                const dummyCars = [
                    {
                        id: 52,
                        title: "2023 Model Lüks Sedan",
                        brand: "Toyota",
                        model: "Corolla",
                        price: "1850000",
                        currency: "TRY",
                        fuel_type: "dizel",
                        gear_type: "otomatik",
                        color: "beyaz",
                        motor_power: "200",
                        motor_volume: "2.0",
                        paint_change: false,
                        kilometer: 15000,
                        drive_type: "ön",
                        fuel_consumption: "5.80",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-14T15:51:21.869Z",
                        case_type: "sedan",
                        user_phone: "5551234568",
                        production_year: 1985,
                        category_id: 18,
                        category_name: "Sedan",
                        from_where: "bireysel",
                        description: "Düşük kilometreli, mükemmel durumda 2023 model lüks sedan."
                    },
                    {
                        id: 47,
                        title: "2023 Model Lüks Sedan",
                        brand: "Mercedes",
                        model: "C-Serisi",
                        price: "1850000",
                        currency: "TRY",
                        fuel_type: "dizel",
                        gear_type: "otomatik",
                        color: "beyaz",
                        motor_power: "200",
                        motor_volume: "2.0",
                        paint_change: false,
                        kilometer: 15000,
                        drive_type: "ön",
                        fuel_consumption: "5.80",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-14T13:13:21.245Z",
                        case_type: "sedan",
                        user_phone: "5551234568",
                        production_year: 2023,
                        category_id: 18,
                        category_name: "Sedan",
                        from_where: "bireysel",
                        description: "Düşük kilometreli, mükemmel durumda 2023 model lüks sedan."
                    },
                    {
                        id: 45,
                        title: "semihten ucuz Araba",
                        brand: "Audi",
                        model: "A3",
                        price: "1500000",
                        currency: "TRY",
                        fuel_type: "Dizel",
                        gear_type: "Otomatik",
                        color: "Gri",
                        motor_power: "170",
                        motor_volume: "1.4 TFSI",
                        paint_change: true,
                        kilometer: 50000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.00",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-13T12:49:24.612Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2017,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "sahibinden",
                        description: "tyt acted 9 bin yaptım bende doktor sayılırım doktordan temiz araba"
                    },
                    {
                        id: 43,
                        title: "2020 Model BMW",
                        brand: "BMW",
                        model: "5 Serisi",
                        price: "500000",
                        currency: "TRY",
                        fuel_type: "Benzin",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: false,
                        kilometer: 4500,
                        drive_type: "Arkadan İtiş",
                        fuel_consumption: "6.00",
                        fuel_tank_capacity: "60.00",
                        created_at: "2025-03-12T11:50:04.375Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2020,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "Sahibinden",
                        description: "test-aciklama"
                    },
                    {
                        id: 42,
                        title: "test data",
                        brand: "Volkswagen",
                        model: "Passat",
                        price: "100000",
                        currency: "TRY",
                        fuel_type: "Benzin",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 45000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T10:57:24.425Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2019,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "test data",
                        description: "test data"
                    },
                    {
                        id: 41,
                        title: "data",
                        brand: "Honda",
                        model: "Civic",
                        price: "1000000",
                        currency: "TRY",
                        fuel_type: "Benzin",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "140",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 10000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T10:51:02.800Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2018,
                        category_id: 1,
                        category_name: "Otomobil",
                        from_where: "data",
                        description: "data"
                    },
                    {
                        id: 40,
                        title: "test",
                        brand: "Ford",
                        model: "Focus",
                        price: "750000",
                        currency: "TRY",
                        fuel_type: "Dizel",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 45000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T10:27:49.539Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2017,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "test",
                        description: "test"
                    },
                    {
                        id: 39,
                        title: "BMW 320i",
                        brand: "BMW",
                        model: "320i",
                        price: "1000000",
                        currency: "TRY",
                        fuel_type: "Dizel",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 45000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T09:59:43.559Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2016,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "bayi",
                        description: "test-aciklama"
                    }
                ];
                
                // URL'den gelen ID'ye göre örnek veriyi bul
                const dummyCar = dummyCars.find(car => car.id === dummyCarId);
                
                // Eğer ID'ye göre örnek veri bulunamazsa, ilk örnek veriyi kullan ama ID'yi güncelle
                if (dummyCar) {
                    return dummyCar;
                } else {
                    // ID'ye göre örnek veri bulunamadıysa, rastgele bir örnek veri seç ve ID'sini güncelle
                    const randomCar = { ...dummyCars[Math.floor(Math.random() * dummyCars.length)] };
                    randomCar.id = dummyCarId;
                    return randomCar;
                }
            }
        }

        // İlan detaylarını sayfaya ekle
        function renderCarDetails(car) {
            // Varsayılan görseller
            const defaultImages = [
                'https://images.unsplash.com/photo-1494976388531-d1058494cdd8?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                'https://images.unsplash.com/photo-1583121274602-3e2820c69888?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                'https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1164&q=80',
                'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                'https://images.unsplash.com/photo-1542362567-b07e54358753?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80'
            ];

            // Tarih formatını düzenle
            const createdDate = new Date(car.created_at);
            const formattedDate = createdDate.toLocaleDateString('tr-TR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Fiyatı formatla
            const formattedPrice = parseFloat(car.price).toLocaleString('tr-TR');
            
            // İlan sahibi bilgisini al
            const fromWhere = car.from_where || 'Belirtilmemiş';

            // İlan detay HTML'ini oluştur
            const carDetailHtml = `
                <div class="property-header">
                    <h1 class="property-title">${car.title}</h1>
                    <div class="property-meta">
                        <span class="property-type">${car.brand} ${car.model}</span>
                        <span class="property-date">İlan Tarihi: ${formattedDate}</span>
                    </div>
                </div>

                <div class="property-main-content">
                    <div class="property-gallery">
                        <div class="main-image">
                            <img src="${defaultImages[0]}" alt="${car.title}" id="mainImage">
                            <button class="gallery-nav prev-btn" id="prevImage" aria-label="Önceki görsel">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="gallery-nav next-btn" id="nextImage" aria-label="Sonraki görsel">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="thumbnail-container">
                            ${defaultImages.map((img, index) => `
                                <div class="thumbnail ${index === 0 ? 'active' : ''}" data-index="${index}">
                                    <img src="${img}" alt="Görsel ${index + 1}">
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="property-info-sidebar">
                        <div class="property-price-section">
                            <div class="property-price">${formattedPrice} TL</div>
                            <button class="favorite-button">
                                <i class="far fa-heart"></i>
                                <span>Favorilere Ekle</span>
                            </button>
                        </div>

                        <div class="property-key-details">
                            <div class="key-detail-item">
                                <div class="key-detail-label">Marka</div>
                                <div class="key-detail-value">${car.brand}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Model</div>
                                <div class="key-detail-value">${car.model}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Seri</div>
                                <div class="key-detail-value">${car.series || 'Belirtilmemiş'}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Yıl</div>
                                <div class="key-detail-value">${car.production_year}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Kilometre</div>
                                <div class="key-detail-value">${car.kilometer.toLocaleString()} km</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Yakıt Tipi</div>
                                <div class="key-detail-value">${car.fuel_type}</div>
                            </div>
                        </div>

                        <div class="property-contact">
                            <h3>İletişim Bilgileri</h3>
                            <div class="contact-info">
                                <div class="contact-item">
                                    <i class="fas fa-user"></i>
                                    <span>${fromWhere}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>+90 ${car.user_phone || '(555) 123 45 67'}</span>
                                </div>
                            </div>
                            <button class="contact-button">İlan Sahibini Ara</button>
                        </div>
                    </div>
                </div>

                <div class="property-description">
                    <h3>İlan Açıklaması</h3>
                    <p>${car.description}</p>
                </div>

                <div class="property-details-grid">
                    <h3>Tüm Özellikler</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">İlan Tipi</div>
                            <div class="detail-value">${car.listing_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Marka</div>
                            <div class="detail-value">${car.brand}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Model</div>
                            <div class="detail-value">${car.model}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Seri</div>
                            <div class="detail-value">${car.series || 'Belirtilmemiş'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Paket</div>
                            <div class="detail-value">${car.series_package || 'Belirtilmemiş'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yıl</div>
                            <div class="detail-value">${car.production_year}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kilometre</div>
                            <div class="detail-value">${car.kilometer.toLocaleString()} km</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yakıt Tipi</div>
                            <div class="detail-value">${car.fuel_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Vites</div>
                            <div class="detail-value">${car.gear_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kasa Tipi</div>
                            <div class="detail-value">${car.case_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Renk</div>
                            <div class="detail-value">${car.color}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Motor Gücü</div>
                            <div class="detail-value">${car.motor_power} HP</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Motor Hacmi</div>
                            <div class="detail-value">${car.motor_volume}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Çekiş</div>
                            <div class="detail-value">${car.drive_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yakıt Tüketimi</div>
                            <div class="detail-value">${car.fuel_consumption} lt/100km</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yakıt Deposu</div>
                            <div class="detail-value">${car.fuel_tank_capacity} lt</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Boya Değişimi</div>
                            <div class="detail-value">${car.paint_change ? 'Var' : 'Yok'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kategori</div>
                            <div class="detail-value">${car.category_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kimden</div>
                            <div class="detail-value">${fromWhere}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('carDetail').innerHTML = carDetailHtml;

            // Görsel galerisi için değişkenler
            let currentImageIndex = 0;
            const images = defaultImages;
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail');
            const prevBtn = document.getElementById('prevImage');
            const nextBtn = document.getElementById('nextImage');
            
            // Ana görsel container'ı
            const mainImageContainer = document.querySelector('.main-image');
            
            // Dokunmatik kaydırma için değişkenler
            let touchStartX = 0;
            let touchEndX = 0;
            
            // Dokunmatik kaydırma olayları
            mainImageContainer.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            
            mainImageContainer.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const diffX = touchEndX - touchStartX;
                
                // Eğer kaydırma mesafesi küçükse, bu bir dokunma olarak kabul edilir
                if (Math.abs(diffX) < 10) {
                    lightboxImage.src = images[currentImageIndex];
                    lightbox.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else {
                    handleSwipe();
                }
            }, false);
            
            // Kaydırma işlemini yönet
            function handleSwipe() {
                const swipeThreshold = 50; // En az 50px kaydırma gerekli
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Sola kaydırma
                    changeImage(currentImageIndex + 1);
                }
                
                if (touchEndX > touchStartX + swipeThreshold) {
                    // Sağa kaydırma
                    changeImage(currentImageIndex - 1);
                }
            }
            
            // Görsel değiştirme fonksiyonu
            function changeImage(index) {
                if (index < 0) index = images.length - 1;
                if (index >= images.length) index = 0;
                
                currentImageIndex = index;
                mainImage.src = images[index];
                
                // Aktif thumbnail'i güncelle
                thumbnails.forEach(thumb => {
                    thumb.classList.remove('active');
                });
                thumbnails[index].classList.add('active');
            }
            
            // Önceki görsel butonu
            prevBtn.addEventListener('click', () => {
                changeImage(currentImageIndex - 1);
            });
            
            // Sonraki görsel butonu
            nextBtn.addEventListener('click', () => {
                changeImage(currentImageIndex + 1);
            });
            
            // Thumbnail tıklama olayları
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    const index = parseInt(thumb.getAttribute('data-index'));
                    changeImage(index);
                });
            });
            
            // Lightbox fonksiyonları
            const lightbox = document.getElementById('imageLightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            const lightboxClose = document.querySelector('.lightbox-close');
            const lightboxPrev = document.querySelector('.lightbox-prev');
            const lightboxNext = document.querySelector('.lightbox-next');
            const lightboxContent = document.querySelector('.lightbox-content');
            
            // Ana görsele tıklandığında lightbox'ı aç
            mainImage.addEventListener('click', openLightbox);
            
            // Thumbnail'lere tıklandığında da lightbox'ı aç
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    changeImage(index);
                    openLightbox();
                });
            });
            
            function openLightbox() {
                lightboxImage.src = images[currentImageIndex];
                lightbox.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            // Lightbox'ı kapat
            lightboxClose.addEventListener('click', closeLightbox);
            
            // Lightbox dışına tıklandığında kapat
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            function closeLightbox() {
                lightbox.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            // Lightbox içinde önceki görsel
            lightboxPrev.addEventListener('click', function() {
                changeImage(currentImageIndex - 1);
                lightboxImage.src = images[currentImageIndex];
            });
            
            // Lightbox içinde sonraki görsel
            lightboxNext.addEventListener('click', function() {
                changeImage(currentImageIndex + 1);
                lightboxImage.src = images[currentImageIndex];
            });
            
            // Klavye ile gezinme
            document.addEventListener('keydown', function(e) {
                if (lightbox.style.display === 'flex') {
                    if (e.key === 'ArrowLeft') {
                        changeImage(currentImageIndex - 1);
                        lightboxImage.src = images[currentImageIndex];
                    } else if (e.key === 'ArrowRight') {
                        changeImage(currentImageIndex + 1);
                        lightboxImage.src = images[currentImageIndex];
                    } else if (e.key === 'Escape') {
                        closeLightbox();
                    }
                }
            });
            
            // Lightbox içinde dokunmatik kaydırma
            let lightboxTouchStartX = 0;
            let lightboxTouchEndX = 0;
            
            lightboxImage.addEventListener('touchstart', function(e) {
                lightboxTouchStartX = e.changedTouches[0].screenX;
            });
            
            lightboxImage.addEventListener('touchend', function(e) {
                lightboxTouchEndX = e.changedTouches[0].screenX;
                handleLightboxSwipe();
            });
            
            function handleLightboxSwipe() {
                const swipeThreshold = 50;
                
                if (lightboxTouchEndX < lightboxTouchStartX - swipeThreshold) {
                    // Sola kaydırma
                    changeImage(currentImageIndex + 1);
                    lightboxImage.src = images[currentImageIndex];
                }
                
                if (lightboxTouchEndX > lightboxTouchStartX + swipeThreshold) {
                    // Sağa kaydırma
                    changeImage(currentImageIndex - 1);
                    lightboxImage.src = images[currentImageIndex];
                }
            }
            
            // Favoriye ekleme fonksiyonu
            document.querySelector('.favorite-button').addEventListener('click', function() {
                const icon = this.querySelector('i');
                icon.classList.toggle('far');
                icon.classList.toggle('fas');
                
                if (icon.classList.contains('fas')) {
                    this.querySelector('span').textContent = 'Favorilerden Çıkar';
                } else {
                    this.querySelector('span').textContent = 'Favorilere Ekle';
                }
            });
        }

        // Benzer araçları yükle
        async function loadSimilarCars(currentCarId) {
            try {
                // Tüm araçları çek
                const allCars = await fetchAllCars();
                
                // Mevcut aracı hariç tut ve en fazla 4 benzer araç göster
                const similarCars = allCars
                    .filter(car => car.id !== parseInt(currentCarId))
                    .slice(0, 4);
                
                const similarCarsContainer = document.getElementById('similarCarsContainer');
                
                if (similarCars.length === 0) {
                    similarCarsContainer.innerHTML = '<p class="no-similar-cars">Benzer araç bulunamadı.</p>';
                    return;
                }
                
                // Başlık ekle
                similarCarsContainer.innerHTML = '<h2 class="similar-cars-title">Benzer Araçlar</h2>';
                
                // Benzer araçlar grid'i oluştur
                const carGrid = document.createElement('div');
                carGrid.className = 'car-grid';
                
                // Her bir benzer araç için kart oluştur
                similarCars.forEach(car => {
                    carGrid.innerHTML += createCarCard(car);
                });
                
                similarCarsContainer.appendChild(carGrid);
            } catch (error) {
                console.error('Benzer araçlar yüklenirken hata oluştu:', error);
                document.getElementById('similarCarsContainer').innerHTML = '<p class="error-message">Benzer araçlar yüklenirken bir hata oluştu.</p>';
            }
        }

        // Araba kartı HTML'i oluştur (cars.html ile aynı)
        function createCarCard(car) {
            // Eksik verilere karşı koruma
            const name = car.name || car.title || 'Bilinmeyen Araç';
            const type = car.type || 'Bilinmeyen Tip';
            
            // Görsel için varsayılan bir placeholder kullan, API'den görsel gelmezse
            const defaultImage = `https://via.placeholder.com/400x250/e0e0e0/333333?text=${encodeURIComponent(name)}`;
            const image = car.image || defaultImage;
            
            const transmission = car.transmission || car.gear_type || 'Bilinmeyen';
            const price = car.price || 0;
            const brand = car.brand || '';
            const model = car.model || '';
            
            return `
                <article class="car-card">
                    <a href="car-detail.html?id=${car.id}" class="car-link" data-car-id="${car.id}">
                        <div class="car-content">
                            <header class="car-header">
                                <div class="car-title-row">
                                    <h2 class="car-name">${name}</h2>
                                    <button class="car-favorite" aria-label="Favorilere ekle" onclick="event.stopPropagation(); event.preventDefault();">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </div>
                                <p class="car-type">${brand} ${model}</p>
                            </header>
                            <img src="${image}" alt="${name}" class="car-image" onerror="this.onerror=null; this.src='${defaultImage}';">
                            <footer class="car-details">
                                <div class="car-specs">
                                    <div class="spec-item">
                                        <i class="fas fa-cog spec-icon"></i>
                                        <span>${transmission}</span>
                                    </div>
                                </div>
                                <p class="car-price">
                                    <span class="price-amount">${typeof price === 'number' ? price.toLocaleString() : price} TL</span>
                                </p>
                            </footer>
                        </div>
                    </a>
                </article>
            `;
        }

        // API'den tüm araçları çek (cars.html ile aynı)
        async function fetchAllCars() {
            try {
                console.log('API isteği gönderiliyor:', 'https://takkas-api.onrender.com/api/vehicle-listings');
                
                const response = await fetch('https://takkas-api.onrender.com/api/vehicle-listings');
                console.log('API yanıt durumu:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`API isteği başarısız oldu: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API yanıtı:', data);
                
                // Eğer data bir array değilse ve data.results varsa, data.results kullanın
                const vehicleData = Array.isArray(data) ? data : (data.results || data.data || []);
                console.log('İşlenecek araç verileri:', vehicleData);
                
                // API'den dönen veriyi işleyin
                const cars = vehicleData.map(car => {
                    // Araç adını belirle
                    const name = car.title || car.name || car.model || 'Bilinmeyen Araç';
                    
                    // Varsayılan görseller
                    const defaultImages = [
                        'https://images.unsplash.com/photo-1583121274602-3e2820c69888?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                        'https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1164&q=80',
                        'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                        'https://images.unsplash.com/photo-1542362567-b07e54358753?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                        'https://images.unsplash.com/photo-1550355291-bbee04a92027?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1236&q=80',
                        'https://images.unsplash.com/photo-1494976388531-d1058494cdd8?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                        'https://images.unsplash.com/photo-1553440569-bcc63803a83d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1125&q=80',
                        'https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80'
                    ];
                    
                    // Rastgele bir görsel seç
                    const randomImage = defaultImages[Math.floor(Math.random() * defaultImages.length)];
                    
                    return {
                        id: car.id,
                        name: name,
                        title: car.title,
                        type: car.case_type || car.type || car.category || car.vehicleType || car.category_name || 'Bilinmeyen Tip',
                        image: car.image_url || car.image || randomImage,
                        passengers: car.passengers || car.capacity || 4,
                        transmission: car.gear_type || car.transmission || car.gearbox || 'Otomatik',
                        price: car.price || car.amount || 100000,
                        brand: car.brand || '',
                        model: car.model || '',
                        production_year: car.production_year || '',
                        kilometer: car.kilometer || 0
                    };
                });
                
                console.log('İşlenmiş araçlar:', cars);
                return cars;
            } catch (error) {
                console.error('Arabalar yüklenirken hata oluştu:', error);
                
                // Hata durumunda örnek veriler döndür
                const dummyCars = [
                    {
                        id: 52,
                        name: "2023 Model Lüks Sedan",
                        title: "2023 Model Lüks Sedan",
                        type: "Sedan",
                        image: 'https://images.unsplash.com/photo-1583121274602-3e2820c69888?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                        passengers: 5,
                        transmission: "Otomatik",
                        price: 1850000,
                        brand: "Toyota",
                        model: "Corolla",
                        production_year: 1985,
                        kilometer: 15000
                    },
                    {
                        id: 47,
                        name: "2023 Model Lüks Sedan",
                        title: "2023 Model Lüks Sedan",
                        type: "Sedan",
                        image: 'https://images.unsplash.com/photo-1605559424843-9e4c228bf1c2?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1164&q=80',
                        passengers: 5,
                        transmission: "Otomatik",
                        price: 1850000,
                        brand: "Mercedes",
                        model: "C-Serisi",
                        production_year: 2023,
                        kilometer: 15000
                    },
                    {
                        id: 45,
                        name: "semihten ucuz Araba",
                        title: "semihten ucuz Araba",
                        type: "Sedan",
                        image: 'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                        passengers: 5,
                        transmission: "Otomatik",
                        price: 1500000,
                        brand: "Audi",
                        model: "A3",
                        production_year: 2017,
                        kilometer: 50000
                    },
                    {
                        id: 43,
                        name: "2020 Model BMW",
                        title: "2020 Model BMW",
                        type: "Sedan",
                        image: 'https://images.unsplash.com/photo-1542362567-b07e54358753?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80',
                        passengers: 5,
                        transmission: "Manuel",
                        price: 500000,
                        brand: "BMW",
                        model: "5 Serisi",
                        production_year: 2020,
                        kilometer: 4500
                    },
                    {
                        id: 42,
                        name: "test data",
                        title: "test data",
                        type: "Sedan",
                        image: 'https://images.unsplash.com/photo-1550355291-bbee04a92027?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1236&q=80',
                        passengers: 5,
                        transmission: "Manuel",
                        price: 100000,
                        brand: "Volkswagen",
                        model: "Passat",
                        production_year: 2019,
                        kilometer: 45000
                    }
                ];
                
                console.log('Hata durumunda örnek veriler döndürülüyor:', dummyCars);
                return dummyCars;
            }
        }

        // Sayfa yüklendiğinde çalışacak fonksiyon
        document.addEventListener('DOMContentLoaded', async function() {
            // URL'den araç ID'sini al
            const urlParams = new URLSearchParams(window.location.search);
            const carId = urlParams.get('id');
            
            if (!carId) {
                showError('Araç ID\'si bulunamadı.');
                return;
            }
            
            try {
                // Araç detaylarını çek
                const car = await fetchCarDetails(carId);
                
                // Araç detaylarını göster
                renderCarDetails(car);
                
                // Benzer araçları yükle
                loadSimilarCars(carId);
                
                // Yükleme animasyonunu gizle
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (error) {
                console.error('Araç detayları yüklenirken hata oluştu:', error);
                showError('Araç detayları yüklenirken bir hata oluştu.');
            }
        });
    </script>
</body>
</html> 