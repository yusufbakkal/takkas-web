<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Araç İlan Detayı - TAKKAS</title>
    
    <!-- CSS Bağlantıları -->
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/property-detail-header.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/car-detail.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Adres bölümü için stiller */
        .property-address {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .property-address h3 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            color: #333;
            border-bottom: 2px solid #4F46E5;
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .address-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .address-line {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
        }

        .address-line i {
            color: #4F46E5;
            font-size: 1.2rem;
        }

        .address-line span {
            font-weight: 500;
            color: #444;
        }

        @media (max-width: 768px) {
            .property-address {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Özel Header Bileşeni -->
    <div id="header-component"></div>

    <!-- Ana İçerik -->
    <main class="property-detail-container">
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
        </div>

        <div class="property-detail" id="carDetail">
            <!-- İlan detayları dinamik olarak buraya eklenecek -->
        </div>

        <!-- Benzer Araçlar Bölümü -->
        <section class="similar-cars-section" id="similarCarsContainer">
            <h2 class="similar-cars-title">Benzer Araçlar</h2>
            <div class="car-grid">
                <!-- Benzer araçlar dinamik olarak buraya eklenecek -->
            </div>
        </section>
    </main>

    <!-- Footer Bileşeni -->
    <div class="full-width-footer-wrapper">
        <div id="footer-component"></div>
    </div>

    <!-- Lightbox -->
    <div id="imageLightbox" class="lightbox">
        <div class="lightbox-content">
            <span class="lightbox-close">&times;</span>
            <img class="lightbox-image" id="lightboxImage">
            <button class="lightbox-nav lightbox-prev">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-nav lightbox-next">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Message popup -->
    <div id="messagePopup" class="message-popup">
        <div class="message-popup-content">
            <div class="message-popup-header">
                <h3>Mesaj gönderin</h3>
                <button class="close-popup">&times;</button>
            </div>
            <div class="message-warning">
                <i class="fas fa-info-circle"></i>
                <span>Güvenliğiniz için kaparo göndermeyin ya da benzeri hiçbir ön ödeme yapmayın.</span>
            </div>
            <div class="message-user-info">
                <div class="message-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-user-details">
                    <div class="message-user-name">${fromWhere}</div>
                    <div class="message-user-type">Platinum Üye</div>
                </div>
            </div>
            <div class="message-quick-buttons">
                <button type="button" class="quick-message-btn">Hala satılık mı?</button>
                <button type="button" class="quick-message-btn">Son fiyat nedir?</button>
                <button type="button" class="quick-message-btn">Hasar durumu nedir?</button>
                <button type="button" class="quick-message-btn">Takas düşünür müsünüz?</button>
            </div>
            <form id="messageForm">
                <div class="form-group">
                    <textarea id="messageText" rows="4" placeholder="Mesaj yazın" required></textarea>
                    <div class="character-count">En az 10 karakter kullanmalısın · 8000 karakter kaldı</div>
                </div>
                <button type="submit" class="send-message-button">Gönder</button>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Bileşenleri yükle
        Promise.all([
            fetch('components/property-detail-header.html').then(response => response.text()),
            fetch('components/footer.html').then(response => response.text())
        ]).then(([header, footer]) => {
            document.getElementById('header-component').innerHTML = header;
            document.getElementById('footer-component').innerHTML = footer;
            
            // Sayfa yüklendikten sonra ilan detaylarını getir
            loadCarDetails();
        });

        // URL'den ilan ID'sini al
        function getCarIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id'); // Varsayılan ID'yi kaldırdık
        }

        // İlan detaylarını yükle
        async function loadCarDetails() {
            const carId = getCarIdFromUrl();
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('active');

            // ID yoksa hata mesajı göster
            if (!carId) {
                spinner.classList.remove('active');
                document.getElementById('carDetail').innerHTML = `
                    <div class="error-message">
                        <h2>Üzgünüz, ilan bulunamadı.</h2>
                        <p>Geçersiz ilan ID'si. <a href="cars.html">Tüm ilanları görüntülemek için tıklayın.</a></p>
                    </div>
                `;
                return;
            }

            try {
                // API'den ilan detaylarını çek
                const carDetails = await fetchCarDetails(carId);
                
                // Görsel verilerini çek
                let carImages = await fetchCarImages(carId);
                
                // Görsel verilerini ilan detaylarına ekle
                carDetails.images = carImages;
                
                // İlan detaylarını sayfaya ekle
                renderCarDetails(carDetails);
                
                // Benzer ilanları yükle
                loadSimilarCars(carId);
            } catch (error) {
                console.error('İlan detayları yüklenirken hata oluştu:', error);
                document.getElementById('carDetail').innerHTML = `
                    <div class="error-message">
                        <h2>Üzgünüz, ilan detayları yüklenemedi.</h2>
                        <p>Lütfen daha sonra tekrar deneyin veya <a href="cars.html">tüm ilanları görüntülemek için tıklayın.</a></p>
                    </div>
                `;
            } finally {
                spinner.classList.remove('active');
            }
        }

        // API'den araç görsellerini çek
        async function fetchCarImages(carId) {
            try {
                const imageUrl = `https://takkas-api.onrender.com/api/listing-photos/${carId}`;
                console.log('Görsel API isteği gönderiliyor:', imageUrl);
                
                const response = await fetch(imageUrl);
                console.log('Görsel API yanıt durumu:', response.status, response.statusText);
                
                if (!response.ok) {
                    console.warn(`${carId} ID'li araç için görseller bulunamadı. HTTP Durumu: ${response.status}`);
                    return null;
                }
                
                const imagesData = await response.json();
                console.log('Görsel API yanıtı:', imagesData);
                
                if (!imagesData || imagesData.length === 0) {
                    console.warn(`${carId} ID'li araç için görseller bulunamadı veya boş dizi döndü.`);
                    return null;
                }
                
                // Sıralama için görsel verilerini düzenle
                // Önce is_primary=true olanları en başa getir, sonra order_index'e göre sırala
                return imagesData.sort((a, b) => {
                    if (a.is_primary && !b.is_primary) return -1;
                    if (!a.is_primary && b.is_primary) return 1;
                    return (a.order_index || 0) - (b.order_index || 0);
                }).map(img => img.url);
            } catch (error) {
                console.error(`${carId} ID'li araç için görseller çekilirken hata:`, error);
                return null;
            }
        }

        // API'den ilan detaylarını çek
        async function fetchCarDetails(carId) {
            try {
                const apiUrl = `https://takkas-api.onrender.com/api/vehicle-listings/${carId}`;
                console.log('API isteği gönderiliyor:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('API yanıt durumu:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`API isteği başarısız oldu: ${response.status} ${response.statusText}`);
                }
                
                let data = await response.json();
                console.log('API yanıtı:', data);
                
                // API boş veri döndürürse veya data null/undefined ise hata fırlat
                if (!data || Object.keys(data).length === 0) {
                    throw new Error('İlan bulunamadı veya API boş veri döndürdü.');
                }
                
                // Adres bilgilerini al
                if (data.address_id) {
                    try {
                        const addressUrl = `https://takkas-api.onrender.com/api/addresses/${data.address_id}`;
                        console.log('Adres bilgisi için API isteği:', addressUrl);
                        
                        const addressResponse = await fetch(addressUrl);
                        
                        if (addressResponse.ok) {
                            const addressData = await addressResponse.json();
                            console.log('Adres API yanıtı:', addressData);
                            
                            // Adres verilerini araba verilerine ekle
                            data = { 
                                ...data, 
                                province_name: addressData.city,
                                district_name: addressData.district,
                                neighborhood_name: addressData.neighborhood
                            };
                        } else {
                            console.error('Adres bilgileri alınamadı:', addressResponse.status);
                        }
                    } catch (addressError) {
                        console.error('Adres bilgileri alınırken hata oluştu:', addressError);
                    }
                }
                
                return data;
            } catch (error) {
                console.error('İlan detayları çekilirken hata oluştu:', error);
                
                // Hata durumunda örnek veri döndür, ancak URL'den gelen ID'yi kullan
                const dummyCarId = parseInt(carId);
                
                // Örnek araç verileri - API'den gelen gerçek verilere göre güncellendi
                const dummyCars = [
                    {
                        id: 52,
                        title: "2023 Model Lüks Sedan",
                        brand: "Toyota",
                        model: "Corolla",
                        price: "1850000",
                        currency: "TRY",
                        fuel_type: "dizel",
                        gear_type: "otomatik",
                        color: "beyaz",
                        motor_power: "200",
                        motor_volume: "2.0",
                        paint_change: false,
                        kilometer: 15000,
                        drive_type: "ön",
                        fuel_consumption: "5.80",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-14T15:51:21.869Z",
                        case_type: "sedan",
                        user_phone: "5551234568",
                        production_year: 1985,
                        category_id: 18,
                        category_name: "Sedan",
                        from_where: "bireysel",
                        description: "Düşük kilometreli, mükemmel durumda 2023 model lüks sedan.",
                        // Adres bilgileri
                        address_id: 123,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    },
                    {
                        id: 47,
                        title: "2023 Model Lüks Sedan",
                        brand: "Mercedes",
                        model: "C-Serisi",
                        price: "1850000",
                        currency: "TRY",
                        fuel_type: "dizel",
                        gear_type: "otomatik",
                        color: "beyaz",
                        motor_power: "200",
                        motor_volume: "2.0",
                        paint_change: false,
                        kilometer: 15000,
                        drive_type: "ön",
                        fuel_consumption: "5.80",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-14T13:13:21.245Z",
                        case_type: "sedan",
                        user_phone: "5551234568",
                        production_year: 2023,
                        category_id: 18,
                        category_name: "Sedan",
                        from_where: "bireysel",
                        description: "Düşük kilometreli, mükemmel durumda 2023 model lüks sedan.",
                        // Adres bilgileri
                        address_id: 124,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    },
                    {
                        id: 45,
                        title: "semihten ucuz Araba",
                        brand: "Audi",
                        model: "A3",
                        price: "1500000",
                        currency: "TRY",
                        fuel_type: "Dizel",
                        gear_type: "Otomatik",
                        color: "Gri",
                        motor_power: "170",
                        motor_volume: "1.4 TFSI",
                        paint_change: true,
                        kilometer: 50000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.00",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-13T12:49:24.612Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2017,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "sahibinden",
                        description: "tyt acted 9 bin yaptım bende doktor sayılırım doktordan temiz araba",
                        // Adres bilgileri
                        address_id: 126,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    },
                    {
                        id: 43,
                        title: "2020 Model BMW",
                        brand: "BMW",
                        model: "5 Serisi",
                        price: "500000",
                        currency: "TRY",
                        fuel_type: "Benzin",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: false,
                        kilometer: 4500,
                        drive_type: "Arkadan İtiş",
                        fuel_consumption: "6.00",
                        fuel_tank_capacity: "60.00",
                        created_at: "2025-03-12T11:50:04.375Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2020,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "Sahibinden",
                        description: "test-aciklama",
                        // Adres bilgileri
                        address_id: 127,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    },
                    {
                        id: 42,
                        title: "test data",
                        brand: "Volkswagen",
                        model: "Passat",
                        price: "100000",
                        currency: "TRY",
                        fuel_type: "Benzin",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 45000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T10:57:24.425Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2019,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "test data",
                        description: "test data",
                        // Adres bilgileri
                        address_id: 128,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    },
                    {
                        id: 41,
                        title: "data",
                        brand: "Honda",
                        model: "Civic",
                        price: "1000000",
                        currency: "TRY",
                        fuel_type: "Benzin",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "140",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 10000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T10:51:02.800Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2018,
                        category_id: 1,
                        category_name: "Otomobil",
                        from_where: "data",
                        description: "data",
                        // Adres bilgileri
                        address_id: 129,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    },
                    {
                        id: 40,
                        title: "test",
                        brand: "Ford",
                        model: "Focus",
                        price: "750000",
                        currency: "TRY",
                        fuel_type: "Dizel",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 45000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T10:27:49.539Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2017,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "test",
                        description: "test",
                        // Adres bilgileri
                        address_id: 130,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    },
                    {
                        id: 39,
                        title: "BMW 320i",
                        brand: "BMW",
                        model: "320i",
                        price: "1000000",
                        currency: "TRY",
                        fuel_type: "Dizel",
                        gear_type: "Manuel",
                        color: "gri",
                        motor_power: "170",
                        motor_volume: "1600",
                        paint_change: true,
                        kilometer: 45000,
                        drive_type: "Önden Çekiş",
                        fuel_consumption: "5.60",
                        fuel_tank_capacity: "55.00",
                        created_at: "2025-03-12T09:59:43.559Z",
                        case_type: "Sedan",
                        user_phone: "5551234567",
                        production_year: 2016,
                        category_id: 16,
                        category_name: "Elektrikli Otomobil",
                        from_where: "bayi",
                        description: "test-aciklama",
                        // Adres bilgileri
                        address_id: 131,
                        province_name: "Antalya",
                        district_name: "Kepez",
                        neighborhood_name: "Habibler Mh."
                    }
                ];
                
                // URL'den gelen ID'ye göre örnek veriyi bul
                const dummyCar = dummyCars.find(car => car.id === dummyCarId);
                
                // Eğer ID'ye göre örnek veri bulunamazsa, ilk örnek veriyi kullan ama ID'yi güncelle
                if (dummyCar) {
                    return dummyCar;
                } else {
                    // ID'ye göre örnek veri bulunamadıysa, rastgele bir örnek veri seç ve ID'sini güncelle
                    const randomCar = { ...dummyCars[Math.floor(Math.random() * dummyCars.length)] };
                    randomCar.id = dummyCarId;
                    return randomCar;
                }
            }
        }

        // İlan detaylarını sayfaya ekle
        function renderCarDetails(car) {
            // "Fotoğraf Bulunamadı" görseli
            const noImagePlaceholder = `https://via.placeholder.com/800x500/e0e0e0/333333?text=${encodeURIComponent('Fotoğraf Bulunamadı')}`;
            
            // API'den gelen görsel verilerini kullan, yoksa fotoğraf bulunamadı görseli kullan
            let carImages = [];
            if (car.images && car.images.length > 0) {
                carImages = car.images;
            } else {
                carImages = [noImagePlaceholder];
            }

            // Tarih formatını düzenle
            const createdDate = new Date(car.created_at);
            const formattedDate = createdDate.toLocaleDateString('tr-TR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Fiyatı formatla
            const formattedPrice = parseFloat(car.price).toLocaleString('tr-TR');
            
            // İlan sahibi bilgisini al
            const fromWhere = car.from_where || 'Belirtilmemiş';

            // İlan detay HTML'ini oluştur
            const carDetailHtml = `
                <div class="property-header">
                    <h1 class="property-title">${car.title}</h1>
                    <div class="property-meta">
                        <span class="property-type">${car.brand} ${car.model}</span>
                        <span class="property-date">İlan Tarihi: ${formattedDate}</span>
                    </div>
                </div>

                <div class="property-main-content">
                    <div class="property-gallery">
                        <div class="main-image">
                            <img src="${carImages[0]}" alt="${car.title}" id="mainImage">
                            <button class="gallery-nav prev-btn" id="prevImage" aria-label="Önceki görsel">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="gallery-nav next-btn" id="nextImage" aria-label="Sonraki görsel">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="thumbnail-container">
                            ${carImages.map((img, index) => `
                                <div class="thumbnail ${index === 0 ? 'active' : ''}" data-index="${index}">
                                    <img src="${img}" alt="Görsel ${index + 1}">
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="property-info-sidebar">
                        <div class="property-price-section">
                            <div class="property-price">${formattedPrice} TL</div>
                            <button class="favorite-button">
                                <i class="far fa-heart"></i>
                                <span>Favorilere Ekle</span>
                            </button>
                        </div>

                        <div class="property-key-details">
                            <div class="key-detail-item">
                                <div class="key-detail-label">Marka</div>
                                <div class="key-detail-value">${car.brand}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Model</div>
                                <div class="key-detail-value">${car.model}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Seri</div>
                                <div class="key-detail-value">${car.series || 'Belirtilmemiş'}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Yıl</div>
                                <div class="key-detail-value">${car.production_year}</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Kilometre</div>
                                <div class="key-detail-value">${car.kilometer.toLocaleString()} km</div>
                            </div>
                            <div class="key-detail-item">
                                <div class="key-detail-label">Yakıt Tipi</div>
                                <div class="key-detail-value">${car.fuel_type}</div>
                            </div>
                        </div>

                        <div class="property-contact">
                            <h3>İletişim Bilgileri</h3>
                            <div class="contact-info">
                                <div class="contact-item">
                                    <i class="fas fa-user"></i>
                                    <span>${fromWhere}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>+90 ${car.user_phone || '(555) 123 45 67'}</span>
                                </div>
                            </div>
                            <button class="contact-button">İlan Sahibini Ara</button>
                            <a href="javascript:void(0);" class="message-link">
                                <i class="fas fa-envelope"></i> Mesaj Gönder
                            </a>
                        </div>
                    </div>
                </div>

                <div class="property-description">
                    <h3>İlan Açıklaması</h3>
                    <p>${car.description}</p>
                </div>

                <div class="property-address">
                    <h3>Adres Bilgileri</h3>
                    <div class="address-info">
                        <div class="address-line">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${car.province_name || 'İl'} / ${car.district_name || 'İlçe'} / ${car.neighborhood_name || 'Mahalle'}</span>
                        </div>
                    </div>
                </div>

                <div class="property-details-grid">
                    <h3>Tüm Özellikler</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">İlan Tipi</div>
                            <div class="detail-value">${car.listing_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Marka</div>
                            <div class="detail-value">${car.brand}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Model</div>
                            <div class="detail-value">${car.model}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Seri</div>
                            <div class="detail-value">${car.series || 'Belirtilmemiş'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Paket</div>
                            <div class="detail-value">${car.series_package || 'Belirtilmemiş'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yıl</div>
                            <div class="detail-value">${car.production_year}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kilometre</div>
                            <div class="detail-value">${car.kilometer.toLocaleString()} km</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yakıt Tipi</div>
                            <div class="detail-value">${car.fuel_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Vites</div>
                            <div class="detail-value">${car.gear_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kasa Tipi</div>
                            <div class="detail-value">${car.case_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Renk</div>
                            <div class="detail-value">${car.color}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Motor Gücü</div>
                            <div class="detail-value">${car.motor_power} HP</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Motor Hacmi</div>
                            <div class="detail-value">${car.motor_volume}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Çekiş</div>
                            <div class="detail-value">${car.drive_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yakıt Tüketimi</div>
                            <div class="detail-value">${car.fuel_consumption} lt/100km</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yakıt Deposu</div>
                            <div class="detail-value">${car.fuel_tank_capacity} lt</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Boya Değişimi</div>
                            <div class="detail-value">${car.paint_change ? 'Var' : 'Yok'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kategori</div>
                            <div class="detail-value">${car.category_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Kimden</div>
                            <div class="detail-value">${fromWhere}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Adres</div>
                            <div class="detail-value">${car.province_name || 'İl'} / ${car.district_name || 'İlçe'} / ${car.neighborhood_name || 'Mahalle'}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('carDetail').innerHTML = carDetailHtml;

            // Message popup HTML'i
            const messagePopupHtml = `
                <div id="messagePopup" class="message-popup">
                    <div class="message-popup-content">
                        <div class="message-popup-header">
                            <h3>Mesaj gönderin</h3>
                            <button class="close-popup">&times;</button>
                        </div>
                        <div class="message-warning">
                            <i class="fas fa-info-circle"></i>
                            <span>Güvenliğiniz için kaparo göndermeyin ya da benzeri hiçbir ön ödeme yapmayın.</span>
                        </div>
                        <div class="message-user-info">
                            <div class="message-user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="message-user-details">
                                <div class="message-user-name">${fromWhere}</div>
                                <div class="message-user-type">Platinum Üye</div>
                            </div>
                        </div>
                        <div class="message-quick-buttons">
                            <button type="button" class="quick-message-btn">Hala satılık mı?</button>
                            <button type="button" class="quick-message-btn">Son fiyat nedir?</button>
                            <button type="button" class="quick-message-btn">Hasar durumu nedir?</button>
                            <button type="button" class="quick-message-btn">Takas düşünür müsünüz?</button>
                        </div>
                        <form id="messageForm">
                            <div class="form-group">
                                <textarea id="messageText" rows="4" placeholder="Mesaj yazın" required></textarea>
                                <div class="character-count">En az 10 karakter kullanmalısın · 8000 karakter kaldı</div>
                            </div>
                            <button type="submit" class="send-message-button">Gönder</button>
                        </form>
                    </div>
                </div>
            `;

            // Message popup'ı body'e ekle
            document.body.insertAdjacentHTML('beforeend', messagePopupHtml);

            // Message popup için değişkenler ve fonksiyonlar
            const messagePopup = document.getElementById('messagePopup');
            const messageLink = document.querySelector('.message-link');
            const closePopup = document.querySelector('.close-popup');
            const messageForm = document.getElementById('messageForm');
            const messageTextarea = document.getElementById('messageText');
            const characterCount = document.querySelector('.character-count');
            const quickButtons = document.querySelectorAll('.quick-message-btn');

            // Karakter sayacı fonksiyonu
            messageTextarea.addEventListener('input', function() {
                const remaining = 8000 - this.value.length;
                characterCount.textContent = `En az 10 karakter kullanmalısın · ${remaining} karakter kaldı`;
                
                // 10 karakterden az ise submit butonunu devre dışı bırak
                const submitButton = document.querySelector('.send-message-button');
                if (this.value.length < 10) {
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.5';
                } else {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                }
            });

            // Hızlı mesaj butonları
            quickButtons.forEach(button => {
                button.addEventListener('click', function() {
                    messageTextarea.value = this.textContent;
                    messageTextarea.dispatchEvent(new Event('input'));
                });
            });

            // Mesaj butonuna tıklandığında popup'ı göster
            messageLink.addEventListener('click', () => {
                messagePopup.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            });

            // Popup'ı kapatma işlemleri
            closePopup.addEventListener('click', () => {
                messagePopup.style.display = 'none';
                document.body.style.overflow = 'auto';
            });

            // Popup dışına tıklandığında kapat
            messagePopup.addEventListener('click', (e) => {
                if (e.target === messagePopup) {
                    messagePopup.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });

            // Form gönderildiğinde
            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // Form verilerini al
                const message = document.getElementById('messageText').value;
                
                // API'ye gönderilecek verileri hazırla
                const messageData = {
                    message,
                    car_id: car.id,
                    user_id: car.user_id
                };
                
                // Burada API entegrasyonu yapılabilir
                console.log('Mesaj verileri:', messageData);
                
                // Başarılı mesaj
                alert('Mesajınız başarıyla gönderildi!');
                
                // Formu temizle ve kapat
                messageForm.reset();
                messagePopup.style.display = 'none';
                document.body.style.overflow = 'auto';
            });

            // Görsel galerisi için değişkenler
            let currentImageIndex = 0;
            const images = carImages;
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail');
            const prevBtn = document.getElementById('prevImage');
            const nextBtn = document.getElementById('nextImage');
            
            // Ana görsel container'ı
            const mainImageContainer = document.querySelector('.main-image');
            
            // Dokunmatik kaydırma için değişkenler
            let touchStartX = 0;
            let touchEndX = 0;
            
            // Dokunmatik kaydırma olayları
            mainImageContainer.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            
            mainImageContainer.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const diffX = touchEndX - touchStartX;
                
                // Eğer kaydırma mesafesi küçükse, bu bir dokunma olarak kabul edilir
                if (Math.abs(diffX) < 10) {
                    lightboxImage.src = images[currentImageIndex];
                    lightbox.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else {
                    handleSwipe();
                }
            }, false);
            
            // Kaydırma işlemini yönet
            function handleSwipe() {
                const swipeThreshold = 50; // En az 50px kaydırma gerekli
                
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Sola kaydırma
                    changeImage(currentImageIndex + 1);
                }
                
                if (touchEndX > touchStartX + swipeThreshold) {
                    // Sağa kaydırma
                    changeImage(currentImageIndex - 1);
                }
            }
            
            // Görsel değiştirme fonksiyonu
            function changeImage(index) {
                if (index < 0) index = images.length - 1;
                if (index >= images.length) index = 0;
                
                currentImageIndex = index;
                mainImage.src = images[index];
                
                // Aktif thumbnail'i güncelle
                thumbnails.forEach(thumb => {
                    thumb.classList.remove('active');
                });
                thumbnails[index].classList.add('active');
            }
            
            // Önceki görsel butonu
            prevBtn.addEventListener('click', () => {
                changeImage(currentImageIndex - 1);
            });
            
            // Sonraki görsel butonu
            nextBtn.addEventListener('click', () => {
                changeImage(currentImageIndex + 1);
            });
            
            // Thumbnail tıklama olayları
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    const index = parseInt(thumb.getAttribute('data-index'));
                    changeImage(index);
                });
            });
            
            // Lightbox fonksiyonları
            const lightbox = document.getElementById('imageLightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            const lightboxClose = document.querySelector('.lightbox-close');
            const lightboxPrev = document.querySelector('.lightbox-prev');
            const lightboxNext = document.querySelector('.lightbox-next');
            const lightboxContent = document.querySelector('.lightbox-content');
            
            // Ana görsele tıklandığında lightbox'ı aç
            mainImage.addEventListener('click', openLightbox);
            
            // Thumbnail'lere tıklandığında da lightbox'ı aç
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    changeImage(index);
                    openLightbox();
                });
            });
            
            function openLightbox() {
                lightboxImage.src = images[currentImageIndex];
                lightbox.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            
            // Lightbox'ı kapat
            lightboxClose.addEventListener('click', closeLightbox);
            
            // Lightbox dışına tıklandığında kapat
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            function closeLightbox() {
                lightbox.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            // Lightbox içinde önceki görsel
            lightboxPrev.addEventListener('click', function() {
                changeImage(currentImageIndex - 1);
                lightboxImage.src = images[currentImageIndex];
            });
            
            // Lightbox içinde sonraki görsel
            lightboxNext.addEventListener('click', function() {
                changeImage(currentImageIndex + 1);
                lightboxImage.src = images[currentImageIndex];
            });
            
            // Klavye ile gezinme
            document.addEventListener('keydown', function(e) {
                if (lightbox.style.display === 'flex') {
                    if (e.key === 'ArrowLeft') {
                        changeImage(currentImageIndex - 1);
                        lightboxImage.src = images[currentImageIndex];
                    } else if (e.key === 'ArrowRight') {
                        changeImage(currentImageIndex + 1);
                        lightboxImage.src = images[currentImageIndex];
                    } else if (e.key === 'Escape') {
                        closeLightbox();
                    }
                }
            });
            
            // Lightbox içinde dokunmatik kaydırma
            let lightboxTouchStartX = 0;
            let lightboxTouchEndX = 0;
            
            lightboxImage.addEventListener('touchstart', function(e) {
                lightboxTouchStartX = e.changedTouches[0].screenX;
            });
            
            lightboxImage.addEventListener('touchend', function(e) {
                lightboxTouchEndX = e.changedTouches[0].screenX;
                handleLightboxSwipe();
            });
            
            function handleLightboxSwipe() {
                const swipeThreshold = 50;
                
                if (lightboxTouchEndX < lightboxTouchStartX - swipeThreshold) {
                    // Sola kaydırma
                    changeImage(currentImageIndex + 1);
                    lightboxImage.src = images[currentImageIndex];
                }
                
                if (lightboxTouchEndX > lightboxTouchStartX + swipeThreshold) {
                    // Sağa kaydırma
                    changeImage(currentImageIndex - 1);
                    lightboxImage.src = images[currentImageIndex];
                }
            }
            
            // Favoriye ekleme fonksiyonu
            document.querySelector('.favorite-button').addEventListener('click', function() {
                const icon = this.querySelector('i');
                icon.classList.toggle('far');
                icon.classList.toggle('fas');
                
                if (icon.classList.contains('fas')) {
                    this.querySelector('span').textContent = 'Favorilerden Çıkar';
                } else {
                    this.querySelector('span').textContent = 'Favorilere Ekle';
                }
            });
        }

        // Benzer araçları yükle
        async function loadSimilarCars(currentCarId) {
            try {
                // Tüm araçları çek
                const allCars = await fetchAllCars();
                
                // Mevcut aracı hariç tut ve en fazla 4 benzer araç göster
                const similarCars = allCars
                    .filter(car => car.id !== parseInt(currentCarId))
                    .slice(0, 4);
                
                const similarCarsContainer = document.getElementById('similarCarsContainer');
                
                if (similarCars.length === 0) {
                    similarCarsContainer.innerHTML = '<p class="no-similar-cars">Benzer araç bulunamadı.</p>';
                    return;
                }
                
                // Başlık ekle
                similarCarsContainer.innerHTML = '<h2 class="similar-cars-title">Benzer Araçlar</h2>';
                
                // Benzer araçlar grid'i oluştur
                const carGrid = document.createElement('div');
                carGrid.className = 'car-grid';
                
                // Her bir benzer araç için kart oluştur
                similarCars.forEach(car => {
                    carGrid.innerHTML += createCarCard(car);
                });
                
                similarCarsContainer.appendChild(carGrid);
            } catch (error) {
                console.error('Benzer araçlar yüklenirken hata oluştu:', error);
                document.getElementById('similarCarsContainer').innerHTML = '<p class="error-message">Benzer araçlar yüklenirken bir hata oluştu.</p>';
            }
        }

        // Araba kartı HTML'i oluştur (cars.html ile aynı)
        function createCarCard(car) {
            // Eksik verilere karşı koruma
            const name = car.name || car.title || 'Bilinmeyen Araç';
            const type = car.type || 'Bilinmeyen Tip';
            
            // Görsel için "Fotoğraf Bulunamadı" görseli kullan, API'den görsel gelmezse
            const noImagePlaceholder = `https://via.placeholder.com/400x250/e0e0e0/333333?text=${encodeURIComponent('Fotoğraf Bulunamadı')}`;
            const image = car.image || noImagePlaceholder;
            
            const transmission = car.transmission || car.gear_type || 'Bilinmeyen';
            const price = car.price || 0;
            const brand = car.brand || '';
            const model = car.model || '';
            
            return `
                <article class="car-card">
                    <a href="car-detail.html?id=${car.id}" class="car-link" data-car-id="${car.id}">
                        <div class="car-content">
                            <header class="car-header">
                                <div class="car-title-row">
                                    <h2 class="car-name">${name}</h2>
                                    <button class="car-favorite" aria-label="Favorilere ekle" onclick="event.stopPropagation(); event.preventDefault();">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </div>
                                <p class="car-type">${brand} ${model}</p>
                            </header>
                            <img src="${image}" alt="${name}" class="car-image" onerror="this.onerror=null; this.src='${noImagePlaceholder}';">
                            <footer class="car-details">
                                <div class="car-specs">
                                    <div class="spec-item">
                                        <i class="fas fa-cog spec-icon"></i>
                                        <span>${transmission}</span>
                                    </div>
                                </div>
                                <p class="car-price">
                                    <span class="price-amount">${typeof price === 'number' ? price.toLocaleString() : price} TL</span>
                                </p>
                            </footer>
                        </div>
                    </a>
                </article>
            `;
        }

        // API'den tüm araçları çek (cars.html ile aynı)
        async function fetchAllCars() {
            try {
                console.log('API isteği gönderiliyor:', 'https://takkas-api.onrender.com/api/vehicle-listings');
                
                const response = await fetch('https://takkas-api.onrender.com/api/vehicle-listings');
                console.log('API yanıt durumu:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`API isteği başarısız oldu: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API yanıtı:', data);
                
                // Eğer data bir array değilse ve data.results varsa, data.results kullanın
                const vehicleData = Array.isArray(data) ? data : (data.results || data.data || []);
                console.log('İşlenecek araç verileri:', vehicleData);
                
                // Araç verilerini işleme ve her araç için görsel çekme
                const carsPromises = vehicleData.map(async car => {
                    // Araç adını belirle
                    const name = car.title || car.name || car.model || 'Bilinmeyen Araç';
                    
                    // Ilan ID'si varsa fotoğrafları çekmeyi dene
                    let carImage = null;
                    if (car.id) {
                        try {
                            const photoUrl = `https://takkas-api.onrender.com/api/listing-photos/${car.id}`;
                            console.log(`Benzer araçlar: ${car.id} ID'li araç için fotoğraf isteği gönderiliyor:`, photoUrl);
                            
                            const photoResponse = await fetch(photoUrl);
                            if (photoResponse.ok) {
                                const photos = await photoResponse.json();
                                console.log(`Benzer araçlar: ${car.id} ID'li araç için fotoğraf yanıtı:`, photos);
                                
                                // İlk fotoğrafı veya ana fotoğrafı (is_primary=true) kullan
                                if (photos && photos.length > 0) {
                                    // Önce is_primary=true olan fotoğrafı ara
                                    const primaryPhoto = photos.find(photo => photo.is_primary === true);
                                    if (primaryPhoto) {
                                        carImage = primaryPhoto.url;
                                    } else {
                                        // Ana fotoğraf yoksa ilk fotoğrafı kullan
                                        carImage = photos[0].url;
                                    }
                                    console.log(`Benzer araçlar: ${car.id} ID'li araç için fotoğraf bulundu:`, carImage);
                                }
                            } else {
                                console.log(`Benzer araçlar: ${car.id} ID'li araç için fotoğraf bulunamadı, HTTP durumu:`, photoResponse.status);
                            }
                        } catch (photoError) {
                            console.error(`Benzer araçlar: ${car.id} ID'li araç için fotoğraf çekilirken hata:`, photoError);
                        }
                    }
                    
                    return {
                        id: car.id,
                        name: name,
                        title: car.title,
                        type: car.case_type || car.type || car.category || car.vehicleType || car.category_name || 'Bilinmeyen Tip',
                        image: carImage || car.image_url || car.image || null,
                        passengers: car.passengers || car.capacity || 4,
                        transmission: car.gear_type || car.transmission || car.gearbox || 'Otomatik',
                        price: car.price || car.amount || 100000,
                        brand: car.brand || '',
                        model: car.model || '',
                        production_year: car.production_year || '',
                        kilometer: car.kilometer || 0
                    };
                });
                
                // Tüm Promise'ları çözümle
                const cars = await Promise.all(carsPromises);
                
                console.log('İşlenmiş araçlar:', cars);
                return cars;
            } catch (error) {
                console.error('Arabalar yüklenirken hata oluştu:', error);
                
                // Hata durumunda örnek veriler döndür
                const dummyCars = [
                    {
                        id: 52,
                        name: "2023 Model Lüks Sedan",
                        title: "2023 Model Lüks Sedan",
                        type: "Sedan",
                        image: null, // Görsel yok, createCarCard "Fotoğraf Bulunamadı" görseli kullanacak
                        passengers: 5,
                        transmission: "Otomatik",
                        price: 1850000,
                        brand: "Toyota",
                        model: "Corolla",
                        production_year: 1985,
                        kilometer: 15000
                    },
                    {
                        id: 47,
                        name: "2023 Model Lüks Sedan",
                        title: "2023 Model Lüks Sedan",
                        type: "Sedan",
                        image: null, // Görsel yok, createCarCard "Fotoğraf Bulunamadı" görseli kullanacak
                        passengers: 5,
                        transmission: "Otomatik",
                        price: 1850000,
                        brand: "Mercedes",
                        model: "C-Serisi",
                        production_year: 2023,
                        kilometer: 15000
                    },
                    {
                        id: 45,
                        name: "semihten ucuz Araba",
                        title: "semihten ucuz Araba",
                        type: "Sedan",
                        image: null, // Görsel yok, createCarCard "Fotoğraf Bulunamadı" görseli kullanacak
                        passengers: 5,
                        transmission: "Otomatik",
                        price: 1500000,
                        brand: "Audi",
                        model: "A3",
                        production_year: 2017,
                        kilometer: 50000
                    },
                    {
                        id: 43,
                        name: "2020 Model BMW",
                        title: "2020 Model BMW",
                        type: "Sedan",
                        image: null, // Görsel yok, createCarCard "Fotoğraf Bulunamadı" görseli kullanacak
                        passengers: 5,
                        transmission: "Manuel",
                        price: 500000,
                        brand: "BMW",
                        model: "5 Serisi",
                        production_year: 2020,
                        kilometer: 4500
                    },
                    {
                        id: 42,
                        name: "test data",
                        title: "test data",
                        type: "Sedan",
                        image: null, // Görsel yok, createCarCard "Fotoğraf Bulunamadı" görseli kullanacak
                        passengers: 5,
                        transmission: "Manuel",
                        price: 100000,
                        brand: "Volkswagen",
                        model: "Passat",
                        production_year: 2019,
                        kilometer: 45000
                    }
                ];
                
                console.log('Hata durumunda örnek veriler döndürülüyor:', dummyCars);
                return dummyCars;
            }
        }

        // Sayfa yüklendiğinde çalışacak fonksiyon
        document.addEventListener('DOMContentLoaded', async function() {
            // URL'den araç ID'sini al
            const urlParams = new URLSearchParams(window.location.search);
            const carId = urlParams.get('id');
            
            if (!carId) {
                showError('Araç ID\'si bulunamadı.');
                return;
            }
            
            try {
                // Araç detaylarını çek
                const car = await fetchCarDetails(carId);
                
                // Araç detaylarını göster
                renderCarDetails(car);
                
                // Benzer araçları yükle
                loadSimilarCars(carId);
                
                // Yükleme animasyonunu gizle
                document.getElementById('loadingSpinner').style.display = 'none';
            } catch (error) {
                console.error('Araç detayları yüklenirken hata oluştu:', error);
                showError('Araç detayları yüklenirken bir hata oluştu.');
            }
        });
    </script>
</body>
</html> 